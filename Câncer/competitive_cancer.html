<!DOCTYPE html>
<html>
  <head>
    <title>Câncer Competitivo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.16/addons/p5.dom.min.js"></script>
    <script>
		var nDose = 1;
		var cancerAlpha = 2;
		var normalAlpha = 3;
		var meanSlider;
		var initialY = 1;
		var initialX = 3000;
		var t = 0;
		var y = initialY; // Cancerous biomass
		var x = initialX; // Normal biomass
		var lambda1 = 0.003; // Impact of cancerous cells in normal biomass
		var lambda2 = 0.00002; // Reduction in cancerous biomass from normal cells
		var r1 = 1;
		var r2 = 0.5;
		var K1 = 5000;
		var K2 = 2000;
		var h = 0.01;
		var prevY;
		var total = 0;
		var acc = y;
		var xOrigin = 400;
		var yOrigin = 400;
		var maxDistance;
		var cells = [];
		var normalPoints = [];
		var tumorPoints = [];
		var wallSize = 10;
		var currentDistance = 0;
		var scatterCoefficient = 230; // Controls the final radius of the tumor
		/*var wallIncrease = scatterCoefficient * (1 / K);
		var maxWallDistance = K * wallIncrease;*/
		var period = 2;
		var dose = 0.2;
	  

    function setup() {
		maxDistance = min([xOrigin, yOrigin]);

		createCanvas(2000, 1000);
		frameRate(120);
		colorMode(HSB, 360, 100, 100, 1);
		noStroke();
		smooth();

		meanSlider = createSlider(-100, 100, 0);
		meanSlider.position(width + 30, 30);
		meanSlider.style("width", "100px");

		textSize(32);
    }

	// r is the growth factor of x1. lambda is the impact of x2 on x1. K is the carrying capacity of x1 (i.e. maximum value)
	function competitiveGrowth(r, x1, x2, K, lambda) {
		return r * x1 * (1 - (x1 / K) - lambda * x2);
	}
	
	function applyChemotherapy(doseAlpha, dose, isNormalCell) {
		var survivalFraction = Math.exp(-doseAlpha * dose);
		console.log(alpha);
		var deadCells;
		if(isNormalCell){
			deadCells = x - (x * survivalFraction);
			x = x - deadCells;
		}else {
			deadCells = y - (y * survivalFraction);
			y = y - deadCells;
		}
		
		return deadCells;
	}

	/*
	function killCells(amount) {
		var integerPortion = Math.floor(amount);
		var fractionalPortion = amount - integerPortion;
		acc -= fractionalPortion;
		
		for (var i = 0; i < integerPortion; i++) {
			var index = Math.floor(random(cells.length));
			cells.splice(index, 1);
			
			currentDistance -= wallIncrease;
			total--;
		}
	}
	*/
	
	function draw() {
		clear();

		var increaseX = (h * competitiveGrowth(r1, x, y, K1, lambda1));
		var increaseY = (h * competitiveGrowth(r2, y, x, K2, lambda2));
		
		if (t > nDose * period) {
			var normalKillCount = applyChemotherapy(normalAlpha, dose, true);
			var cancerKillCount = applyChemotherapy(cancerAlpha, dose, false);
			console.log("Killed " + normalKillCount + " normals and " + cancerKillCount + " cancerous.");
			//killCells(killCount);
			
			nDose++;
		}
		
		//acc += increase;
		y += increaseY;
		x += increaseX;

		/*
		while (acc > 1) {
			// Create a new cell for each whole number
			var angle = random(TWO_PI);
			var distance = random(currentDistance, currentDistance + wallSize);

			cells.push({
				x: xOrigin + distance * cos(angle),
				y: yOrigin + distance * sin(angle),
				distance: distance,
				hue: random(30)
			});

			total++;
			acc--;
			currentDistance += wallIncrease;
		}
		*/

		var maxY = max([K1, K2]);
		insertPoint(normalPoints, x, initialX, maxY, true);
		insertPoint(tumorPoints, y, initialY, maxY, false);

		drawElements();
		text("Celulas normais " + x, 800, 600);
		text("Celulas cancerigenas " + y, 800, 700);
			
		t = t + h;
	}
	
	function insertPoint(points, value, initial, maxValue, isNormal) {
		var xc = map(t, 0, 100, 0, width);
		var yc = map(value, 0, maxValue, 500, 100);

		points.push({
			x: xc + (2 * maxDistance) + 20,
			y: yc,
			hue: isNormal ? 120 : 300
		});
	}
	  
	function drawElements() {
		// Draw chart
		[normalPoints, tumorPoints].forEach(function(points) {
			for (var i = 0; i < points.length; i++) {
				var p = points[i];
				stroke(p.hue, 100, 100, 1);
				if (i == 0) {
					point(p.x, p.y);
				} else {
					var prevP = points[i - 1];
					line(prevP.x, prevP.y, p.x, p.y); 
				}
			}
		});
      
		/*
		// Draw cells
		for (var i = cells.length - 1; i >= 0; i--) {		
			var cell = cells[i];

			var fromWall = currentDistance - cell.distance;
			var hue = 360;
			var brightness = 100;
			// Core starts to turn necrotic when the wall reaches 80% of its size
			var threshold = maxWallDistance * 0.8;

			if (fromWall > threshold) {
				hue = map(fromWall, threshold, maxWallDistance, 360, 270);
				brightness = map(fromWall, threshold, maxWallDistance, 100, 0);
			}

			var radius = map(cell.distance, 0, maxWallDistance, 10, 20);

			noStroke();
			fill(hue - cell.hue, 100, brightness, 1);
			ellipse(cell.x, cell.y, radius, radius);

			var movement = map(fromWall, 0, maxWallDistance, 3, 1);
			cells[i].x += random(-movement, movement);
			cells[i].y += random(-movement, movement);
		}
		
		text("N. células: (" + total + "/" + K + ")", 800, 600);
		text("t: " + t, 800, 700);
		*/
	}
    </script>
  </head>
  <body>
  </body>
</html>
